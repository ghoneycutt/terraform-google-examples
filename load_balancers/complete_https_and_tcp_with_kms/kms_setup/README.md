# Google KMS keyring and crypto key module

This module enables the Cloud KMS API and creates both a keyring and a crypto
key necessary for encrypting secrets. If you have one or more of those
already built feel free to use them, but if not then create them by executing
this Terraform module (you will need to provide a `project_id` and `region`)

Make sure that the `GOOGLE_APPLICATION_CREDENTIALS` environment variable has
been populated with the path to the JSON key for the load balancer service
account that was created by the `service_account` module. If it has not been
set or the JSON key has not been downloaded, then you will need to ensure
both of those steps have been followed.

Next, execute Terraform:

    terraform init
    terraform plan -out kms.out
    terraform apply kms.out

Once the keyring and the crypto key are created, the next step is to gather
the SSL certificate and private key that will be used for your load balancers
in the `certs_and_lbs` module. If you HAVE two of these already available
then great - make sure their files are available and skip step 1. If not,
follow step 1 to generate self-signed certificates.

After you have encrypted each KMS secret (storing both certificates and private keys) and provided their ciphertext values as input for this module you can run Terraform and bring up all the infrastructure


1. Generate two self-signed certificates to be used by the HTTPS load balancer

    ```shell
    openssl req -newkey rsa:2048 -nodes -keyout key.pem -x509 -days 365 -out certificate.pem

    openssl req -newkey rsa:2048 -nodes -keyout key2.pem -x509 -days 365 -out certificate2.pem
    ```

2. Create `terraform.tfvars` in the root of the `certs_and_lbs` module directory and populate it with values for `project_id` and `region`
3. Encrypt both certificates and keys by hand, and save the ciphertext strings that are generated by each command:

    ```shell
    cat certificate.pem | gcloud kms encrypt \
    --project <PROJECT_ID> \
    --location <REGION> \
    --keyring load-balancer-key-ring \
    --key load-balancer-crypto-key \
    --plaintext-file - \
    --ciphertext-file - \
    | base64

    cat key.pem | gcloud kms encrypt \
    --project <PROJECT_ID> \
    --location <REGION> \
    --keyring load-balancer-key-ring \
    --key load-balancer-crypto-key \
    --ciphertext-file - \
    | base64

    cat certificate2.pem | gcloud kms encrypt \
    --project <PROJECT_ID> \
    --location <REGION> \
    --keyring load-balancer-key-ring \
    --key load-balancer-crypto-key \
    --plaintext-file - \
    --ciphertext-file - \
    | base64

    cat key2.pem | gcloud kms encrypt \
    --project <PROJECT_ID> \
    --location <REGION> \
    --keyring load-balancer-key-ring \
    --key load-balancer-crypto-key \
    --ciphertext-file - \
    | base64
    ```

4. Each command will output a ciphertext string that can be used to set the `certificate_ciphertext`, `key_ciphertext`, `certificate2_ciphertext`, and `key2_ciphertext` input variables in the `terraform.tfvars` you created in step 2
5. Check the `README` for the `certs_and_lbs` module for further instructions

